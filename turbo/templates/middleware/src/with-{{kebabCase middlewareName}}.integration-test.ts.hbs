import { describe, suite, test, type TestContext } from "node:test";

import { createTestServer } from "@qfetch/test-utils";

import { with{{pascalCase middlewareName}} } from "./with-{{kebabCase middlewareName}}.ts";

/* node:coverage disable */

suite("with{{pascalCase middlewareName}} - Integration", { concurrency: true }, () => {
	// TODO: Add integration tests for your middleware

	describe("behavior description from user perspective", () => {
		test("handles successful requests", async (ctx: TestContext) => {
			// Arrange
			ctx.plan(1);
			const { baseUrl } = await createTestServer(ctx, (req, res) => {
				const url = new URL(req.url || "/", "http://localhost");
				const path = url.pathname;

				// TODO: Add route handlers for your middleware's behavior

				if (path === "/success") {
					res.writeHead(200, { "Content-Type": "application/json" });
					res.end(JSON.stringify({ message: "Success!" }));
					return;
				}

				res.writeHead(404, { "Content-Type": "application/json" });
				res.end(JSON.stringify({ error: "Not Found" }));
			});
			const qfetch = with{{pascalCase middlewareName}}({
				// TODO: Add options
			})(fetch);

			// Act
			const response = await qfetch(`${baseUrl}/success`, {
				signal: ctx.signal,
			});

			// Assert
			ctx.assert.strictEqual(
				response.status,
				200,
				"returns successful status",
			);
		});
	});
});
