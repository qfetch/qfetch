name: Release Verify

on:
  pull_request:
    branches: [main]

jobs:
  detect-release-please:
    if: startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-24.04
    outputs:
      package_path: ${{ steps.extract.outputs.package_path }}
      package_name: ${{ steps.extract.outputs.package_name }}

    steps:
      - name: Extract package info from branch
        id: extract
        run: |
          # Branch format: release-please--branches--main--components--packages-<package-name>
          BRANCH="${{ github.head_ref }}"

          # Extract package directory name (e.g., "middleware-retry-after" from "packages-middleware-retry-after")
          PACKAGE_DIR=$(echo "$BRANCH" | sed 's/.*--packages-//')

          echo "package_path=packages/$PACKAGE_DIR" >> "$GITHUB_OUTPUT"
          echo "package_name=@qfetch/$PACKAGE_DIR" >> "$GITHUB_OUTPUT"

  verify-jsr:
    needs: detect-release-please
    timeout-minutes: 2
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Enable Corepack
        run: corepack enable

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: |
            .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: "package.json"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --filter=${{ needs.detect-release-please.outputs.package_name }}...

      - name: Verify JSR publish
        run: pnpx jsr publish --dry-run
        working-directory: ${{ needs.detect-release-please.outputs.package_path }}

  verify-npm:
    needs: detect-release-please
    timeout-minutes: 2
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Enable Corepack
        run: corepack enable

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: |
            .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: "package.json"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --filter=${{ needs.detect-release-please.outputs.package_name }}...

      - name: Build package
        run: pnpm build --filter=${{ needs.detect-release-please.outputs.package_name }}

      - name: Verify npm publish
        run: npm publish --dry-run
        working-directory: ${{ needs.detect-release-please.outputs.package_path }}
